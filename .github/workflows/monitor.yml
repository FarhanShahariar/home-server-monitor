name: Home Server Monitor

on:
  schedule:
    - cron: "* * * * *"   # every minute
  workflow_dispatch:

jobs:
  monitor:
    runs-on: ubuntu-latest

    steps:
      - name: Restore last status
        uses: actions/cache@v4
        with:
          path: status.txt
          key: server-status

      - name: Read last status
        id: last
        run: |
          if [ -f status.txt ]; then
            echo "last=$(cat status.txt)" >> $GITHUB_OUTPUT
          else
            echo "last=unknown" >> $GITHUB_OUTPUT
          fi

      - name: Ping server
        id: check
        run: |
          if ping -c 2 -W 3 ${{ secrets.SERVER_IP }} > /dev/null; then
            echo "current=online" >> $GITHUB_OUTPUT
          else
            echo "current=offline" >> $GITHUB_OUTPUT
          fi

      - name: Send Telegram notification on change
        if: steps.check.outputs.current != steps.last.outputs.last
        run: |
          if [ "${{ steps.check.outputs.current }}" = "offline" ]; then
            MSG="ğŸš¨ Ubuntu Server OFFLINE!"
          else
            MSG="âœ… Ubuntu Server BACK ONLINE!"
          fi

          curl -s -X POST "https://api.telegram.org/bot${{ secrets.BOT_TOKEN }}/sendMessage" \
            -d chat_id=${{ secrets.CHAT_ID }} \
            -d text="$MSG"

      - name: Save current status
        run: echo "${{ steps.check.outputs.current }}" > status.txt
