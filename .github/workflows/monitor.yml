name: Home Server Monitor

on:
  schedule:
    - cron: '*/1 * * * *'
  workflow_dispatch:

jobs:
  monitor:
    runs-on: ubuntu-latest

    permissions:
      issues: write

    steps:
      - name: Read last status from issue
        id: last
        run: |
          STATUS=$(curl -s \
            -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github+json" \
            https://api.github.com/repos/${{ github.repository }}/issues \
            | jq -r '.[] | select(.title=="SERVER_STATUS") | .body')

          if [ -z "$STATUS" ] || [ "$STATUS" = "null" ]; then
            STATUS="online"
          fi

          echo "last=$STATUS" >> $GITHUB_OUTPUT

      - name: Check server
        id: check
        run: |
          if ping -c 3 ${{ secrets.SERVER_IP }} > /dev/null; then
            CURRENT="online"
          else
            CURRENT="offline"
          fi

          echo "current=$CURRENT" >> $GITHUB_OUTPUT

      - name: OFFLINE alert
        if: steps.check.outputs.current == 'offline' && steps.last.outputs.last != 'offline'
        run: |
          curl -s "https://api.telegram.org/bot${{ secrets.BOT_TOKEN }}/sendMessage" \
            -d chat_id=${{ secrets.CHAT_ID }} \
            -d text="ðŸš¨ ALERT!\nHome Ubuntu Server is OFFLINE!\nðŸ•’ $(date)"

      - name: ONLINE alert
        if: steps.check.outputs.current == 'online' && steps.last.outputs.last == 'offline'
        run: |
          curl -s "https://api.telegram.org/bot${{ secrets.BOT_TOKEN }}/sendMessage" \
            -d chat_id=${{ secrets.CHAT_ID }} \
            -d text="âœ… RECOVERED!\nHome Ubuntu Server is BACK ONLINE!\nðŸ•’ $(date)"

      - name: Update status in issue
        run: |
          ISSUE_NUMBER=$(curl -s \
            -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github+json" \
            https://api.github.com/repos/${{ github.repository }}/issues \
            | jq -r '.[] | select(.title=="SERVER_STATUS") | .number')

          curl -s -X PATCH \
            -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github+json" \
            https://api.github.com/repos/${{ github.repository }}/issues/$ISSUE_NUMBER \
            -d "{\"body\":\"${{ steps.check.outputs.current }}\"}"
