name: Home Server Monitor

on:
  schedule:
    - cron: "* * * * *"   # every minute (FREE)
  workflow_dispatch:

jobs:
  monitor:
    runs-on: ubuntu-latest

    steps:
      - name: Load last status
        id: last
        run: |
          if [ -f status.txt ]; then
            echo "last=$(cat status.txt)" >> $GITHUB_OUTPUT
          else
            echo "last=unknown" >> $GITHUB_OUTPUT
          fi

      - name: Check server (SSH port 22)
        id: check
        run: |
          if timeout 5 bash -c "</dev/tcp/${{ secrets.SERVER_IP }}/22" 2>/dev/null; then
            CURRENT="online"
          else
            CURRENT="offline"
          fi
          echo "current=$CURRENT" >> $GITHUB_OUTPUT

      - name: Notify Telegram on status change
        if: steps.check.outputs.current != steps.last.outputs.last
        run: |
          STATUS="${{ steps.check.outputs.current }}"
          if [ "$STATUS" = "offline" ]; then
            MSG="ðŸš¨ Ubuntu Server OFFLINE!"
          else
            MSG="âœ… Ubuntu Server BACK ONLINE!"
          fi

          curl -s -X POST "https://api.telegram.org/bot${{ secrets.BOT_TOKEN }}/sendMessage" \
            -d chat_id=${{ secrets.CHAT_ID }} \
            -d text="$MSG"

      - name: Save status
        run: echo "${{ steps.check.outputs.current }}" > status.txt
